name: 000 CI

# ============================================================
# Purpose: Run dependency review, linting, and conditional similarity analysis on push/PR
# Triggers: push to main/master, pull requests, manual dispatch
# Permissions: contents:read, pull-requests:write (dependency-review job)
# Inputs: None
# Outputs: Similarity analysis artifacts (embeddings.csv, similarity_results.csv) when triggered
# Secrets: GITHUB_TOKEN (automatic)
# Variables: None
# Preconditions: None
# ============================================================

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  dependency-review:
    runs-on: ubuntu-latest
    # Run on all pull requests to check for dependency changes
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Dependency Review
      uses: actions/dependency-review-action@v4

  lint:
    needs: [dependency-review]
    runs-on: ubuntu-latest
    # Run after dependency-review completes (or is skipped)
    if: always()

    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Run linter
      run: npm run lint

  check-similarity-trigger:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read

    outputs:
      should_run: ${{ steps.check-files.outputs.should_run }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Check if similarity-related files changed
      id: check-files
      run: |
        # Check if similarity.js or text-similarity workflow was modified
        git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD > changed-files.txt

        if grep -E 'similarity\.js|\.github/workflows/text-similarity\.yml' changed-files.txt; then
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "Similarity-related files were modified, will trigger analysis"
        else
          echo "should_run=false" >> $GITHUB_OUTPUT
          echo "No similarity-related files modified, skipping analysis"
        fi

  run-similarity:
    needs: check-similarity-trigger
    runs-on: ubuntu-latest
    if: needs.check-similarity-trigger.outputs.should_run == 'true'

    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm install

    - name: Cache Transformers.js models
      uses: actions/cache@v5
      with:
        path: .cache/transformers
        key: transformers-models-${{ hashFiles('package.json') }}
        restore-keys: |
          transformers-models-

    - name: Run text similarity analysis
      run: npm run similarity

    - name: Upload similarity analysis outputs
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: similarity-outputs-pr
        path: |
          embeddings.csv
          similarity_results.csv
        retention-days: 90
