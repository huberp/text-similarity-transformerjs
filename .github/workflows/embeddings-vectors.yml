name: 010 PREPROC / embeddings-vectors

# ============================================================
# Purpose: Compute embeddings from corpus and create vector index for downstream workflows
# Triggers: push to main/master (on corpus/workflow changes), manual dispatch
# Permissions: contents:write
# Inputs: Text files in test_corpus directory
# Outputs: vector-index.zip in data-latest and versioned releases, embeddings.csv artifact
# Secrets: GITHUB_TOKEN (automatic)
# Variables: None
# Preconditions: None
# ============================================================

on:
  push:
    branches: [ main, master ]
    paths:
      - 'test_corpus/**'
      - 'embeddings.js'
      - '.github/workflows/embeddings-vectors.yml'
      - 'package.json'
  workflow_dispatch:

jobs:
  compute-embeddings:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Cache Transformers.js models
      uses: actions/cache@v4
      with:
        path: .cache/transformers
        key: transformers-models-${{ hashFiles('package.json') }}
        restore-keys: |
          transformers-models-
      
    - name: Compute embeddings and create LocalIndex
      run: npm run embeddings
      
    - name: Create timestamp for release tag
      id: timestamp
      run: echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
    - name: Zip vector-index directory
      run: |
        cd vector-index
        zip -r ../vector-index.zip .
        cd ..
        ls -lh vector-index.zip
      
    - name: Create/Update GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: data-latest
        name: "Intermediate Data (Latest)"
        body: |
          Automatically generated intermediate data for workflows.
          
          **Generated**: ${{ steps.timestamp.outputs.timestamp }}
          **Commit**: ${{ github.sha }}
          
          This release contains intermediate data files.
          See individual workflow runs for details on each asset.
        files: vector-index.zip
        draft: false
        prerelease: false
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Create versioned release tag
      uses: softprops/action-gh-release@v2
      with:
        tag_name: data-v${{ steps.timestamp.outputs.timestamp }}
        name: "Intermediate Data ${{ steps.timestamp.outputs.timestamp }}"
        body: |
          Versioned snapshot of intermediate data.
          
          **Generated**: ${{ steps.timestamp.outputs.timestamp }}
          **Commit**: ${{ github.sha }}
          
          This release contains:
          - `vector-index.zip` - Embeddings LocalIndex
        files: vector-index.zip
        draft: false
        prerelease: false
        make_latest: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Upload embeddings CSV
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: embeddings-csv
        path: embeddings.csv
        retention-days: 90
