name: 011 PREPROC / Corpus Similarity Analysis

# ============================================================
# Purpose: Analyze similarity across corpus using pre-computed embeddings from vector index
# Triggers: push to main/master (on corpus/workflow changes), pull requests, manual dispatch
# Permissions: contents:read
# Inputs: vector-index.zip from data-latest release
# Outputs: similarity_results.csv artifact
# Secrets: GITHUB_TOKEN (automatic)
# Variables: None
# Preconditions: embeddings-vectors workflow must have run to create vector-index.zip
# ============================================================

on:
  push:
    branches: [ main, master ]
    paths:
      - 'test_corpus/**'
      - 'similarity-analysis.js'
      - '.github/workflows/corpus-similarity-analysis.yml'
      - 'package.json'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'test_corpus/**'
      - 'similarity-analysis.js'
      - '.github/workflows/corpus-similarity-analysis.yml'
      - 'package.json'
  workflow_dispatch:

concurrency:
  group: corpus-similarity-analysis-${{ github.ref }}
  cancel-in-progress: true

jobs:
  similarity-analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Download vector-index from release
      run: |
        echo "Downloading vector-index.zip from data-latest release..."
        if ! gh release download data-latest --pattern 'vector-index.zip'; then
          echo "=========================================="
          echo "ERROR: vector-index.zip not found!"
          echo "=========================================="
          echo ""
          echo "The vector-index.zip file is not available in the data-latest release."
          echo "Please run the 'embeddings-vectors' workflow first to generate the embeddings."
          echo ""
          echo "To generate the embeddings:"
          echo "  1. Go to Actions â†’ '010 PREPROC / embeddings-vectors'"
          echo "  2. Click 'Run workflow'"
          echo "  3. Wait for it to complete"
          echo "  4. Re-run this workflow"
          echo ""
          exit 1
        fi
        echo "Successfully downloaded vector-index.zip"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Unzip vector-index
      run: |
        mkdir -p vector-index
        unzip -o vector-index.zip -d vector-index/
        ls -lh vector-index/
        if [ ! -f "vector-index/index.json" ]; then
          echo "ERROR: index.json not found in vector-index directory"
          exit 1
        fi
        echo "Successfully extracted vector-index"
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run corpus similarity analysis
      run: npm run similarity-analysis
      
    - name: Upload similarity analysis outputs
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: similarity-analysis-outputs
        path: |
          similarity_results.csv
        retention-days: 90
