name: 013 PREPROC / TF-IDF Vector Store

# ============================================================
# Purpose: Build TF-IDF vector store from pre-computed TF-IDF data
# Triggers: push to main/master (on tfidf-data/workflow changes), manual dispatch
# Permissions: contents:read
# Inputs: tfidf-data.zip from data-latest release
# Outputs: tfidf-vector-index directory and tfidf_vectors.csv artifacts
# Secrets: GITHUB_TOKEN (automatic)
# Variables: None
# Preconditions: tfidf workflow must have run to create tfidf-data.zip
# ============================================================

on:
  push:
    branches: [ main, master ]
    paths:
      - 'tfidf-data/**'
      - 'tfidf-vectors.js'
      - '.github/workflows/tfidf-vectors.yml'
  workflow_dispatch:

concurrency:
  group: tfidf-vectors-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tfidf-vectors:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Download tfidf-data from release
      run: |
        echo "Downloading tfidf-data.zip from data-latest release..."
        if ! gh release download data-latest --pattern 'tfidf-data.zip'; then
          echo "=========================================="
          echo "ERROR: tfidf-data.zip not found!"
          echo "=========================================="
          echo ""
          echo "The tfidf-data.zip file is not available in the data-latest release."
          echo "Please run the 'TF-IDF Analysis' workflow first to generate the TF-IDF data."
          echo ""
          echo "To generate the TF-IDF data:"
          echo "  1. Go to Actions â†’ 'TF-IDF Analysis'"
          echo "  2. Click 'Run workflow'"
          echo "  3. Wait for it to complete"
          echo "  4. Re-run this workflow"
          echo ""
          exit 1
        fi
        echo "Successfully downloaded tfidf-data.zip"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Unzip tfidf-data
      run: |
        mkdir -p tfidf-data
        unzip -o tfidf-data.zip -d tfidf-data/
        ls -lh tfidf-data/
        echo "Successfully extracted tfidf-data"
      
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: npm install
      
    - name: Build TF-IDF vector store
      run: npm run tfidf-vectors
      
    - name: Upload TF-IDF vector store
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: tfidf-vector-store
        path: |
          tfidf-vector-index/
          tfidf_vectors.csv
        retention-days: 90
